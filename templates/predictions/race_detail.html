{% extends 'base.html' %}
{% load circuit_tags %}
{% block title %}{{ gp.name }} - F1 Porras{% endblock %}

{% block content %}
<!-- Header -->
<div class="row g-4 mb-4">
  <div class="col-lg-7">
    <div class="d-flex align-items-center gap-3 mb-3">
      <a href="{% url 'predictions:races' %}" class="btn btn-sm btn-outline-secondary">&larr; Calendario</a>
      <span class="text-muted">Round {{ gp.round }}</span>
    </div>

    <h1 class="pixel-title mb-3">{{ gp.name }}</h1>
    <p class="text-muted mb-3">{{ gp.country }} - {{ gp.circuit }}</p>

    <!-- Status badges -->
    <div class="d-flex flex-wrap gap-2 mb-4">
      {% if gp.is_locked %}
      <span class="badge-pixel badge-closed">CERRADO</span>
      {% else %}
      <span class="badge-pixel badge-open">ABIERTO</span>
      {% endif %}
    </div>

    <!-- Deadline info -->
    {% if gp.deadline_utc %}
    <div class="{% if gp.is_locked %}pixel-box{% else %}pixel-box-accent{% endif %} mb-4">
      <p class="small text-muted mb-1">Deadline predicciones:</p>
      <p class="mb-0 {% if gp.is_locked %}text-closed{% else %}text-accent{% endif %}">
        {{ gp.deadline_utc|date:"d M Y, H:i" }} UTC
      </p>
      {% if gp.is_locked %}
      <p class="small text-muted mt-2 mb-0">Las predicciones estan cerradas para este GP</p>
      {% endif %}
    </div>
    {% endif %}

    <!-- Action button -->
    {% if user.is_authenticated %}
      {% if not gp.is_locked %}
      <a href="{% url 'predictions:pick' gp.slug %}" class="btn btn-warning btn-lg mb-4">
        {% if user_prediction %}Editar mi pick{% else %}Hacer mi pick{% endif %}
      </a>
      {% endif %}
    {% else %}
    <div class="card-dark p-3 mb-4">
      <p class="mb-2">Inicia sesion para hacer tu prediccion</p>
      <a href="{% url 'login' %}" class="btn btn-outline-light btn-sm">Login</a>
      <a href="{% url 'predictions:signup' %}" class="btn btn-warning btn-sm">Registrarse</a>
    </div>
    {% endif %}
  </div>

  <div class="col-lg-5">
    {% circuit_slot gp.slug "track-slot-lg" %}
  </div>
</div>

<div class="row g-4">
  <!-- Sessions -->
  <div class="col-lg-7">
    <h3 class="pixel-title-sm mb-3">SESIONES</h3>
    <div class="card-dark">
      <div class="table-responsive">
        <table class="table table-dark mb-0 session-table">
          <thead>
            <tr>
              <th>Sesion</th>
              <th>Fecha/Hora (UTC)</th>
            </tr>
          </thead>
          <tbody>
            {% for session in sessions %}
            <tr>
              <td>{{ session.get_session_type_display }}</td>
              <td>{{ session.start_utc|date:"d M Y, H:i" }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="2" class="text-muted">No hay sesiones programadas</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- User prediction -->
  <div class="col-lg-5">
    {% if user.is_authenticated and user_prediction %}
    <h3 class="pixel-title-sm mb-3">TU PREDICCION</h3>
    <div class="prediction-summary">
      <div class="mb-3">
        <p class="small text-muted mb-2">Top 5:</p>
        <div class="d-flex flex-wrap gap-1">
          <span class="driver-chip"><strong>P1:</strong> {{ user_prediction.p1.name }}</span>
          <span class="driver-chip"><strong>P2:</strong> {{ user_prediction.p2.name }}</span>
          <span class="driver-chip"><strong>P3:</strong> {{ user_prediction.p3.name }}</span>
          <span class="driver-chip"><strong>P4:</strong> {{ user_prediction.p4.name }}</span>
          <span class="driver-chip"><strong>P5:</strong> {{ user_prediction.p5.name }}</span>
        </div>
      </div>
      <div class="mb-3">
        <p class="small text-muted mb-1">Posicion Alonso:</p>
        <span class="driver-chip">
          {% if user_prediction.alonso_pos_guess == 0 %}DNF{% else %}P{{ user_prediction.alonso_pos_guess }}{% endif %}
        </span>
      </div>

      {% if user_prediction.score is not None %}
      <div class="mt-3 pt-3 border-top border-secondary">
        <p class="small text-muted mb-1">Puntuacion:</p>
        <span class="pixel-title-sm text-accent">{{ user_prediction.score }} PTS</span>
      </div>
      {% endif %}

      {% if not gp.is_locked %}
      <div class="mt-3">
        <a href="{% url 'predictions:pick' gp.slug %}" class="btn btn-outline-light btn-sm">
          Editar pick
        </a>
      </div>
      {% endif %}
    </div>
    {% elif user.is_authenticated and not gp.is_locked %}
    <h3 class="pixel-title-sm mb-3">TU PREDICCION</h3>
    <div class="pixel-box text-center py-4">
      <p class="text-muted mb-3">Aun no has hecho tu prediccion</p>
      <a href="{% url 'predictions:pick' gp.slug %}" class="btn btn-warning">
        Hacer pick ahora
      </a>
    </div>
    {% elif user.is_authenticated and gp.is_locked %}
    <h3 class="pixel-title-sm mb-3">TU PREDICCION</h3>
    <div class="pixel-box text-center py-4">
      <p class="text-muted mb-0">No hiciste prediccion para este GP</p>
      <p class="small text-closed mt-2 mb-0">Deadline pasado</p>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
